generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BaasProviderName {
  MOCK
  STRIPE_ISSUING
  LITHIC
  UNIT
  OTHER
  SYNCTERA
}

enum AuthHoldStatus {
  PENDING
  CLEARED
  REVERSED
  EXPIRED
}

enum WalletSpendPolicy {
  PAYER_ONLY
  EQUAL_SPLIT
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  name           String?
  googleId       String?         @unique
  createdAt      DateTime        @default(now())
  kycStatus      String?
  ledgerAccounts LedgerAccount[]
  walletsAdmin   Wallet[]        @relation("WalletAdmin")
  memberships    WalletMember[]

  baasCustomer      BaasCustomer?
  baasCards         BaasCard[]
  baasFundingRoutes BaasFundingRoute[]
  cardAuthHolds     CardAuthHold[]
  baasAccounts      BaasAccount[]
}

model Wallet {
  id                         String             @id @default(uuid())
  name                       String
  adminId                    String
  createdAt                  DateTime           @default(now())
  providerFinancialAccountId String?
  spendPolicy                WalletSpendPolicy  @default(PAYER_ONLY)
  cards                      Card[]
  ledgerAccounts             LedgerAccount[]
  admin                      User               @relation("WalletAdmin", fields: [adminId], references: [id])
  walletBalance              WalletBalance?
  members                    WalletMember[]
  baasCards                  BaasCard[]
  baasAccounts               BaasAccount[]
  baasFundingRoutes          BaasFundingRoute[]
  cardAuthHolds              CardAuthHold[]
}

model WalletBalance {
  id        String   @id @default(uuid())
  walletId  String   @unique
  amount    Int      @default(0)
  updatedAt DateTime @default(now()) @updatedAt
  wallet    Wallet   @relation(fields: [walletId], references: [id])
}

model WalletMember {
  id       String   @id @default(uuid())
  walletId String
  userId   String
  role     String
  joinedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id])
  wallet   Wallet   @relation(fields: [walletId], references: [id])
}

model Card {
  id             String  @id @default(uuid())
  walletId       String
  providerCardId String?
  status         String  @default("inactive")
  wallet         Wallet  @relation(fields: [walletId], references: [id])
}

model LedgerAccount {
  id            String        @id @default(uuid())
  walletId      String
  userId        String?
  type          String
  balance       Int           @default(0)
  createdAt     DateTime      @default(now())
  user          User?         @relation(fields: [userId], references: [id])
  wallet        Wallet        @relation(fields: [walletId], references: [id])
  creditEntries LedgerEntry[] @relation("CreditRelation")
  debitEntries  LedgerEntry[] @relation("DebitRelation")
}

model LedgerEntry {
  id              String        @id @default(uuid())
  transactionId   String
  debitAccountId  String
  creditAccountId String
  amount          Int
  timestamp       DateTime      @default(now())
  metadata        Json?
  creditAccount   LedgerAccount @relation("CreditRelation", fields: [creditAccountId], references: [id])
  debitAccount    LedgerAccount @relation("DebitRelation", fields: [debitAccountId], references: [id])
}

model BaasCustomer {
  id                 String           @id @default(cuid())
  userId             String           @unique
  providerName       BaasProviderName
  externalCustomerId String           @unique
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  accounts BaasAccount[]
  cards BaasCard[]
}

model BaasAccount {
  id                 String           @id @default(cuid())
  userId             String
  walletId           String?
  baasCustomerId     String?
  providerName       BaasProviderName
  externalAccountId  String           @unique
  accountType        String
  currency           String
  status             String           @default("ACTIVE")
  accessStatus       String?
  accountNumberLast4 String?
  routingNumber      String?
  metadata           Json?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  wallet       Wallet?       @relation(fields: [walletId], references: [id])
  baasCustomer BaasCustomer? @relation(fields: [baasCustomerId], references: [id])
  cards        BaasCard[]
  fundingRoutes BaasFundingRoute[]
}

model BaasCard {
  id             String           @id @default(cuid())
  userId         String
  walletId       String? // optional link to a "default" wallet for this card
  baasCustomerId String?
  baasAccountId  String?
  providerName   BaasProviderName
  externalCardId String           @unique
  last4          String?
  status         String           @default("ACTIVE")
  nickname       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  wallet       Wallet?       @relation(fields: [walletId], references: [id])
  baasCustomer BaasCustomer? @relation(fields: [baasCustomerId], references: [id])
  baasAccount  BaasAccount?  @relation(fields: [baasAccountId], references: [id])
}

model BaasEvent {
  id              String           @id @default(cuid())
  providerName    BaasProviderName
  providerEventId String
  type            String // e.g. "CARD_AUTH", "CARD_CLEARING", "WALLET_FUNDING"
  payload         Json
  processedAt     DateTime?
  createdAt       DateTime         @default(now())

  @@unique([providerName, providerEventId])
}

model BaasFundingRoute {
  id                String           @id @default(cuid())
  providerName      BaasProviderName
  providerAccountId String
  reference         String?
  walletId          String
  userId            String
  baasAccountId     String?
  createdAt         DateTime         @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  baasAccount BaasAccount? @relation(fields: [baasAccountId], references: [id])

  @@unique([providerName, providerAccountId, reference])
}

model CardAuthHold {
  id             String           @id @default(cuid())
  providerName   BaasProviderName
  providerAuthId String
  providerCardId String
  walletId       String
  userId         String
  amountMinor    Int
  currency       String
  status         AuthHoldStatus   @default(PENDING)
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  clearedAt      DateTime?
  reversedAt     DateTime?

  wallet Wallet @relation(fields: [walletId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([providerName, providerAuthId])
}
