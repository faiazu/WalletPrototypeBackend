generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BaasProviderName {
  MOCK
  STRIPE_ISSUING
  LITHIC
  UNIT
  OTHER
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  name           String?
  googleId       String?         @unique
  createdAt      DateTime        @default(now())
  kycStatus      String?
  ledgerAccounts LedgerAccount[]
  walletsAdmin   Wallet[]        @relation("WalletAdmin")
  memberships    WalletMember[]

  baasCustomer   BaasCustomer?
  baasCards      BaasCard[]
  baasFundingRoutes BaasFundingRoute[]
}

model Wallet {
  id                         String          @id @default(uuid())
  name                       String
  adminId                    String
  createdAt                  DateTime        @default(now())
  providerFinancialAccountId String?
  cards                      Card[]
  ledgerAccounts             LedgerAccount[]
  admin                      User            @relation("WalletAdmin", fields: [adminId], references: [id])
  walletBalance              WalletBalance?
  members                    WalletMember[]
  baasCards                  BaasCard[]
  baasFundingRoutes          BaasFundingRoute[]
}

model WalletBalance {
  id        String   @id @default(uuid())
  walletId  String   @unique
  amount    Int      @default(0)
  updatedAt DateTime @default(now()) @updatedAt
  wallet    Wallet   @relation(fields: [walletId], references: [id])
}

model WalletMember {
  id       String   @id @default(uuid())
  walletId String
  userId   String
  role     String
  joinedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id])
  wallet   Wallet   @relation(fields: [walletId], references: [id])
}

model Card {
  id             String  @id @default(uuid())
  walletId       String
  providerCardId String?
  status         String  @default("inactive")
  wallet         Wallet  @relation(fields: [walletId], references: [id])
}

model LedgerAccount {
  id            String        @id @default(uuid())
  walletId      String
  userId        String?
  type          String
  balance       Int           @default(0)
  createdAt     DateTime      @default(now())
  user          User?         @relation(fields: [userId], references: [id])
  wallet        Wallet        @relation(fields: [walletId], references: [id])
  creditEntries LedgerEntry[] @relation("CreditRelation")
  debitEntries  LedgerEntry[] @relation("DebitRelation")
}

model LedgerEntry {
  id              String        @id @default(uuid())
  transactionId   String
  debitAccountId  String
  creditAccountId String
  amount          Int
  timestamp       DateTime      @default(now())
  metadata        Json?
  creditAccount   LedgerAccount @relation("CreditRelation", fields: [creditAccountId], references: [id])
  debitAccount    LedgerAccount @relation("DebitRelation", fields: [debitAccountId], references: [id])
}

model BaasCustomer {
  id                 String           @id @default(cuid())
  userId             String           @unique
  providerName       BaasProviderName
  externalCustomerId String           @unique
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  cards BaasCard[]
}

model BaasCard {
  id             String           @id @default(cuid())
  userId         String
  walletId       String? // optional link to a "default" wallet for this card
  providerName   BaasProviderName
  externalCardId String           @unique
  last4          String?
  status         String           @default("ACTIVE")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user           User          @relation(fields: [userId], references: [id])
  wallet         Wallet?       @relation(fields: [walletId], references: [id])
  baasCustomer   BaasCustomer? @relation(fields: [baasCustomerId], references: [id])
  baasCustomerId String?
}

model BaasEvent {
  id             String           @id @default(cuid())
  providerName   BaasProviderName
  providerEventId String
  type           String           // e.g. "CARD_AUTH", "CARD_CLEARING", "WALLET_FUNDING"
  payload        Json
  processedAt    DateTime?
  createdAt      DateTime         @default(now())

  @@unique([providerName, providerEventId])
}

model BaasFundingRoute {
  id               String          @id @default(cuid())
  providerName     BaasProviderName
  providerAccountId String
  reference        String?
  walletId         String
  userId           String
  createdAt        DateTime        @default(now())

  wallet           Wallet          @relation(fields: [walletId], references: [id])
  user             User            @relation(fields: [userId], references: [id])

  @@unique([providerName, providerAccountId, reference])
}
